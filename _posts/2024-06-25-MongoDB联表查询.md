# MongoDB 中，联表查询

在 MongoDB 中，联表查询（即连接查询）与传统的关系型数据库有所不同。由于 MongoDB 是一个文档型 NoSQL 数据库，它不直接支持 SQL 中的 `JOIN` 操作。然而，MongoDB 提供了几种方式来实现类似的功能，包括嵌入文档、手动 `JOIN` 和 `$lookup` 聚合操作符。

### 使用 `$lookup` 进行联表查询

`$lookup` 是 MongoDB 聚合框架中的一个操作符，可以实现跨集合的联表查询。以下是如何使用 `$lookup` 的一个示例。

#### 范例场景

假设我们有两个集合：`orders`（订单）和 `customers`（客户）。

##### `orders` 集合
```json
{
    "_id": ObjectId("1"),
    "order_id": "1001",
    "customer_id": "101",
    "total": 500
}
```

##### `customers` 集合
```json
{
    "_id": ObjectId("101"),
    "name": "Alice",
    "email": "alice@example.com"
}
```

我们想要查询所有订单，并包含每个订单相关的客户信息。

#### 使用 `$lookup` 实现联表查询

```javascript
db.orders.aggregate([
    {
        $lookup: {
            from: "customers",           // 目标集合
            localField: "customer_id",   // 当前集合中的字段
            foreignField: "_id",         // 目标集合中的字段
            as: "customer_info"          // 输出字段
        }
    },
    {
        $unwind: "$customer_info"        // 将数组展平
    }
])
```

#### 结果
```json
{
    "_id": ObjectId("1"),
    "order_id": "1001",
    "customer_id": "101",
    "total": 500,
    "customer_info": {
        "_id": ObjectId("101"),
        "name": "Alice",
        "email": "alice@example.com"
    }
}
```

### 示例扩展：包括多个字段的查询

假设我们有三个集合：`orders`、`customers` 和 `products`，其中 `orders` 集合中的每个订单包含一个 `product_ids` 数组。

##### `orders` 集合
```json
{
    "_id": ObjectId("1"),
    "order_id": "1001",
    "customer_id": "101",
    "product_ids": ["201", "202"],
    "total": 500
}
```

##### `products` 集合
```json
{
    "_id": ObjectId("201"),
    "name": "Product A",
    "price": 100
},
{
    "_id": ObjectId("202"),
    "name": "Product B",
    "price": 150
}
```

#### 使用 `$lookup` 联表查询多个集合

```javascript
db.orders.aggregate([
    {
        $lookup: {
            from: "customers",
            localField: "customer_id",
            foreignField: "_id",
            as: "customer_info"
        }
    },
    {
        $unwind: "$customer_info"
    },
    {
        $lookup: {
            from: "products",
            localField: "product_ids",
            foreignField: "_id",
            as: "product_details"
        }
    }
])
```

#### 结果
```json
{
    "_id": ObjectId("1"),
    "order_id": "1001",
    "customer_id": "101",
    "product_ids": ["201", "202"],
    "total": 500,
    "customer_info": {
        "_id": ObjectId("101"),
        "name": "Alice",
        "email": "alice@example.com"
    },
    "product_details": [
        {
            "_id": ObjectId("201"),
            "name": "Product A",
            "price": 100
        },
        {
            "_id": ObjectId("202"),
            "name": "Product B",
            "price": 150
        }
    ]
}
```

### 总结

在 MongoDB 中，使用 `$lookup` 可以实现类似于 SQL 的 `JOIN` 操作，通过聚合框架将不同集合中的数据关联起来。这种方法特别适合于需要在应用层进行复杂数据聚合和分析的场景。理解和掌握 MongoDB 的聚合框架和 `$lookup` 操作符，可以帮助开发人员高效地处理多集合数据关联的需求。

